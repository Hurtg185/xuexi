---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Socials from "@/components/Socials.astro";
import LinkButton from "@/components/LinkButton.astro";
import Card from "@/components/Card.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import IconRss from "@/assets/icons/IconRss.svg";
import IconArrowRight from "@/assets/icons/IconArrowRight.svg";
import { SITE } from "@/config";
import { SOCIALS } from "@/constants";

const posts = await getCollection("blog");
const sortedPosts = getSortedPosts(posts);
const featuredPosts = sortedPosts.filter(({ data }) => data.featured);
const recentPosts = sortedPosts.filter(({ data }) => !data.featured);
---

<Layout>
  <div class="app-shell">
    <!-- Sidebar -->
    <aside id="mobile-sidebar" class="sidebar" aria-hidden="true">
      <div class="sidebar-head">
        <h2>菜单</h2>
        <button id="close-sidebar" aria-label="关闭菜单">✕</button>
      </div>
      <nav class="sidebar-nav">
        <a href="/">首页</a>
        <a href="/posts/">文章</a>
        <a href="/tags/">标签</a>
        <a href="/about/">关于</a>
      </nav>
    </aside>

    <!-- Overlay -->
    <div id="sidebar-overlay" class="overlay" hidden></div>

    <!-- Main -->
    <div class="main-layer">
      <Header />
      <main id="main-content" data-layout="index" class="app-layout pb-safe">
        <section id="hero" class:list={["pt-8 pb-6", "border-b border-border"]}>
          <div class="hero-top">
            <button id="open-sidebar" class="menu-btn" aria-label="打开菜单">☰</button>
            <h1 class="my-4 inline-block text-4xl font-bold sm:my-8 sm:text-5xl">Mingalaba</h1>
            <a target="_blank" href="/rss.xml" class="inline-block" aria-label="rss feed" title="RSS Feed">
              <IconRss width={20} height={20} class="scale-125 stroke-accent stroke-3 rtl:-rotate-90" />
              <span class="sr-only">RSS Feed</span>
            </a>
          </div>

          <p>AstroPaper is a minimal, responsive, accessible and SEO-friendly Astro blog theme.</p>
          <p class="mt-2">
            Read the blog posts or check
            <LinkButton class="underline decoration-dashed underline-offset-4 hover:text-accent" href="https://github.com/satnaing/astro-paper#readme">
              README
            </LinkButton>
            for more info.
          </p>

          {SOCIALS.length > 0 && (
            <div class="mt-4 flex max-sm:flex-col sm:items-center">
              <div class="me-2 mb-1 whitespace-nowrap sm:mb-0">Social Links:</div>
              <Socials />
            </div>
          )}
        </section>

        {featuredPosts.length > 0 && (
          <section id="featured" class:list={["pt-12 pb-6", { "border-b border-border": recentPosts.length > 0 }]}>
            <h2 class="text-2xl font-semibold tracking-wide">Featured</h2>
            <ul>{featuredPosts.map(data => <Card variant="h3" {...data} />)}</ul>
          </section>
        )}

        {recentPosts.length > 0 && (
          <section id="recent-posts" class="pt-12 pb-6">
            <h2 class="text-2xl font-semibold tracking-wide">Recent Posts</h2>
            <ul>
              {recentPosts.map((data, index) => index < SITE.postPerIndex && <Card variant="h3" {...data} />)}
            </ul>
          </section>
        )}

        <div class="my-8 text-center">
          <LinkButton href="/posts/">
            All Posts
            <IconArrowRight class="inline-block rtl:-rotate-180" />
          </LinkButton>
        </div>
      </main>
      <Footer />
    </div>

    <!-- Bottom nav (mobile) -->
    <nav class="bottom-nav" aria-label="底部导航">
      <button id="bottom-menu-btn" class="bottom-item" type="button">菜单</button>
      <a class="bottom-item" href="/">首页</a>
      <a class="bottom-item" href="/posts/">文章</a>
      <a class="bottom-item" href="/tags/">标签</a>
    </nav>
  </div>
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    const mainContent = document.querySelector("#main-content") as HTMLElement | null;
    const indexLayout = mainContent?.dataset?.layout;
    if (indexLayout) sessionStorage.setItem("backUrl", "/");

    const sidebar = document.getElementById("mobile-sidebar");
    const overlay = document.getElementById("sidebar-overlay");
    const openBtn = document.getElementById("open-sidebar");
    const closeBtn = document.getElementById("close-sidebar");
    const bottomMenuBtn = document.getElementById("bottom-menu-btn");

    const openSidebar = () => {
      sidebar?.classList.add("is-open");
      overlay?.removeAttribute("hidden");
      requestAnimationFrame(() => overlay?.classList.add("is-show"));
      document.body.style.overflow = "hidden";
    };

    const closeSidebar = () => {
      sidebar?.classList.remove("is-open");
      overlay?.classList.remove("is-show");
      setTimeout(() => overlay?.setAttribute("hidden", ""), 220);
      document.body.style.overflow = "";
    };

    openBtn?.addEventListener("click", openSidebar);
    closeBtn?.addEventListener("click", closeSidebar);
    overlay?.addEventListener("click", closeSidebar);
    bottomMenuBtn?.addEventListener("click", openSidebar);
  });
</script>

<style>
  .app-shell { position: relative; min-height: 100vh; }
  .main-layer { position: relative; z-index: 1; }

  .sidebar {
    position: fixed; inset: 0 auto 0 0; width: 280px; max-width: 82vw;
    background: var(--background, #fff); transform: translateX(-100%);
    transition: transform .24s ease; z-index: 40; border-right: 1px solid var(--border);
    padding: 1rem;
  }
  .sidebar.is-open { transform: translateX(0); }
  .sidebar-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: .75rem; }
  .sidebar-nav a { display: block; padding: .7rem .4rem; border-radius: .5rem; }
  .sidebar-nav a:hover { background: color-mix(in srgb, var(--accent) 12%, transparent); }

  .overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,.45); opacity: 0;
    transition: opacity .22s ease; z-index: 30;
  }
  .overlay.is-show { opacity: 1; }

  .hero-top { display: flex; align-items: center; gap: .75rem; }
  .menu-btn { border: 1px solid var(--border); border-radius: 999px; padding: .35rem .6rem; }

  .bottom-nav {
    position: fixed; left: 0; right: 0; bottom: 0; z-index: 25;
    display: grid; grid-template-columns: repeat(4, 1fr);
    background: color-mix(in srgb, var(--background) 85%, transparent);
    backdrop-filter: blur(10px); border-top: 1px solid var(--border);
  }
  .bottom-item { text-align: center; padding: .7rem .25rem; font-size: .9rem; }

  .pb-safe { padding-bottom: 4.25rem; }

  @media (min-width: 768px) {
    .bottom-nav { display: none; }
    .menu-btn { display: none; }
    .pb-safe { padding-bottom: 0; }
  }
</style>
